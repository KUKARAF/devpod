#!/usr/bin/env bash
set -euo pipefail

# Do not run inside Zellij
if [[ -n "${ZELLIJ:-}" ]]; then
  echo "Already inside Zellij. Detach or use Ctrl-o w."
  exit 1
fi

# Resolve git root
GIT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "$GIT_ROOT" ]]; then
  echo "Error: not inside a git repository"
  exit 1
fi

BASE_NAME="$(basename "$GIT_ROOT")"

get_sessions() {
  zellij ls 2>/dev/null \
    | awk '{print $1}' \
    | grep -E "^${BASE_NAME}(-|$)" || true
}

pick_session() {
  fzf --prompt="zellij (${BASE_NAME})> " --height=40% --reverse
}

case "${1:-}" in
  clear)
    SESSIONS="$(get_sessions)"
    [[ -z "$SESSIONS" ]] && {
      echo "No sessions for $BASE_NAME"
      exit 0
    }

    echo "$SESSIONS" | while read -r s; do
      echo "Deleting $s"
      zellij delete-session "$s"
    done
    ;;

  new)
    read -rp "Suffix for new session (${BASE_NAME}-<suffix>): " SUFFIX
    [[ -z "$SUFFIX" ]] && exit 1
    exec zellij attach -c "${BASE_NAME}-${SUFFIX}"
    ;;

  "")
    SESSIONS="$(get_sessions)"
    COUNT="$(echo "$SESSIONS" | sed '/^$/d' | wc -l)"

    if [[ "$COUNT" -eq 0 ]]; then
      SUFFIX="$(tr -dc a-z0-9 </dev/urandom | head -c 4)"
      exec zellij attach -c "${BASE_NAME}-${SUFFIX}"

    elif [[ "$COUNT" -eq 1 ]]; then
      exec zellij attach "$(echo "$SESSIONS")"

    else
      SESSION="$(echo "$SESSIONS" | pick_session)"
      [[ -z "$SESSION" ]] && exit 1
      exec zellij attach "$SESSION"
    fi
    ;;

  *)
    echo "Usage:"
    echo "  zj        attach / pick / create"
    echo "  zj new    create new session"
    echo "  zj clear  delete repo sessions"
    exit 1
    ;;
esac

